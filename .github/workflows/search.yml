name: Podcast Search
# Refreshed: Fix Quotes 2

on:
  workflow_dispatch:
    inputs:
      query:
        description: 'Search query'
        required: true
        default: ''
      limit:
        description: 'Number of results'
        required: false
        default: '10'

jobs:
  search:
    runs-on: ubuntu-latest
    
    steps:
      # Super Optimized: No checkout, No setup-python, No pip install
      # Uses system tools only for maximum speed
      
      - name: Search via System Tools
        run: |
          # URL Encode query using python one-liner (standard lib)
          QUERY="${{ github.event.inputs.query }}"
          LIMIT="${{ github.event.inputs.limit }}"
          
          # Use python3 already installed on runner to encode URL
          ENCODED_QUERY=$(python3 -c "import urllib.parse; print(urllib.parse.quote('''$QUERY'''))")
          
          echo "Searching for: $QUERY"
          
          # Curl request to iTunes API
          URL="https://itunes.apple.com/search?term=$ENCODED_QUERY&entity=podcast&limit=$LIMIT"
          curl -s "$URL" > /tmp/response.json
          
          # Process with python standard lib (no installs needed)
          python3 -c "
          import sys, json, base64
          try:
              # Parse JSON response from file (safer than string injection)
              with open('/tmp/response.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
              results = {'podcasts': data.get('results', [])}
              count = len(results['podcasts'])
              print(f'Found {count} results')
              
              # Output result wrapped in base64
              json_str = json.dumps(results, ensure_ascii=False)
              encoded = base64.b64encode(json_str.encode('utf-8')).decode('ascii')
              
              print('===RESULTS_START===')
              print(encoded)
              print('===RESULTS_END===')
          except Exception as e:
              print(f'Error processing: {e}')
              sys.exit(1)
          "