name: Download Podcasts

on:
  workflow_dispatch:
    inputs:
      feed_url:
        description: 'RSS Feed URL'
        required: false
      episode_url:
        description: 'Single episode URL to download'
        required: false
      episode_title:
        description: 'Title for single episode'
        required: false
      episodes_json:
        description: 'Multiple episodes as JSON array'
        required: false
      podcast_title:
        description: 'Podcast title for multiple episodes'
        required: false
      folder:
        description: 'Download folder'
        required: false
        default: 'downloads'

jobs:
  download:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Download episodes
        env:
          EPISODE_TITLE: ${{ github.event.inputs.episode_title }}
          EPISODES_JSON: ${{ github.event.inputs.episodes_json }}
        run: |
          mkdir -p "${{ github.event.inputs.folder }}"
          
          if [ -n "$EPISODES_JSON" ]; then
            echo "Downloading multiple episodes from JSON"
            python3 write_episodes_json.py
            python3 download_multiple_episodes.py /tmp/episodes.json "${{ github.event.inputs.folder }}"
            
          elif [ -n "${{ github.event.inputs.episode_url }}" ]; then
            echo "Downloading single episode: ${{ github.event.inputs.episode_url }}"
            
            if [ -n "$EPISODE_TITLE" ]; then
              python3 write_title.py
              FILENAME=$(python3 generate_filename_from_file.py /tmp/episode_title.txt)
            else
              FILENAME="episode_$(date +%Y%m%d_%H%M%S).mp3"
            fi
            
            wget -O "${{ github.event.inputs.folder }}/$FILENAME" "${{ github.event.inputs.episode_url }}" || curl -L -o "${{ github.event.inputs.folder }}/$FILENAME" "${{ github.event.inputs.episode_url }}"
          fi
            
      - name: Clean file names for upload
        if: success()
        run: python3 clean_hebrew_filenames.py "${{ github.event.inputs.folder }}"
          
      - name: Upload artifacts as release
        if: success()
        run: |
          TAG_NAME="download-$(date +%Y%m%d-%H%M%S)-$RANDOM"
          
          gh release create "$TAG_NAME" --title "Podcast Download - $(date)" --notes "Downloaded podcasts" --latest=false || true
          
          MP3_FILES=()
          while IFS= read -r -d '' file; do
            MP3_FILES+=("$file")
          done < <(find "${{ github.event.inputs.folder }}" -name "*.mp3" -type f -print0)
          
          if [ ${#MP3_FILES[@]} -gt 0 ]; then
            python3 upload_to_release.py "${{ secrets.GITHUB_TOKEN }}" "${{ github.repository_owner }}" "${{ github.event.repository.name }}" "$TAG_NAME" "${MP3_FILES[@]}"
          fi
          
          echo "===RESULTS_START==="
          echo "$TAG_NAME"
          echo "===RESULTS_END==="
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
