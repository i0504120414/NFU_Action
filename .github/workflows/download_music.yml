name: Download Music from YouTube

on:
  workflow_dispatch:
    inputs:
      query:
        description: 'Search query for YouTube'
        required: true
      video_ids:
        description: 'Comma-separated YouTube video IDs'
        required: false
      folder:
        description: 'Download folder'
        required: false
        default: 'music'

jobs:
  download:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install yt-dlp and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade yt-dlp mutagen
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          
      - name: Download music
        env:
          VIDEO_IDS: ${{ github.event.inputs.video_ids }}
        run: |
          mkdir -p "${{ github.event.inputs.folder }}"
          
          if [ -n "$VIDEO_IDS" ]; then
            IFS=',' read -ra IDS <<< "$VIDEO_IDS"
            for id in "${IDS[@]}"; do
              id=$(echo "$id" | xargs)
              if [[ "$id" == http* ]]; then
                URL="$id"
              else
                URL="https://youtube.com/watch?v=$id"
              fi
              yt-dlp --format "bestaudio/best" --extract-audio --audio-format mp3 --audio-quality 5 --add-metadata --embed-thumbnail --output "${{ github.event.inputs.folder }}/%(title)s.%(ext)s" "$URL" || true
            done
          else
            yt-dlp --format "bestaudio/best" --extract-audio --audio-format mp3 --audio-quality 5 --add-metadata --embed-thumbnail --max-downloads 1 --output "${{ github.event.inputs.folder }}/%(title)s.%(ext)s" "ytsearch:${{ github.event.inputs.query }}" || true
          fi
          
      - name: Upload to release
        if: success()
        run: |
          TAG_NAME="music-$(date +%Y%m%d-%H%M%S)-$RANDOM"
          
          gh release create "$TAG_NAME" --title "Music Download - $(date)" --notes "Downloaded from YouTube" --latest=false || true
          
          for file in "${{ github.event.inputs.folder }}"/*.mp3; do
            [ -f "$file" ] && gh release upload "$TAG_NAME" "$file" --clobber || true
          done
          
          echo "===RESULTS_START==="
          echo "{\"release_tag\":\"$TAG_NAME\"}"
          echo "===RESULTS_END==="
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
